<%@ Master Language="C#" %>
<%@ Import Namespace="System.Globalization" %>
<%@ Import Namespace="System.Web.Routing" %>
<%@ Import Namespace="RestFoundation" %>
<%@ Import Namespace="RestFoundation.Security" %>

<script runat="server" language="C#">
    private readonly RestOptions configurationOptions = Rest.Configuration.Options;    

    protected void Page_Init(object sender, EventArgs e)
    {
        ValidateHttpSecurity();
        ValidateIPRange();
        AuthorizeUserIfNecessary();
    }

    private void ValidateHttpSecurity()
    {
        if (!configurationOptions.ServiceProxyHttpsOnly || Request.IsSecureConnection)
        {
            return;
        }

        Response.Clear();
        Response.StatusCode = 403;
        Response.StatusDescription = "HTTPS required";
        Response.End();
    }

    private void ValidateIPRange()
    {
        List<IPAddressRange> ranges = IPAddressRange.GetConfiguredRanges("serviceProxyAcl").ToList();

        if (ranges.Count == 0)
        {
            return;
        }

        bool isAllowed = false;

        foreach (var range in ranges)
        {
            if (range.IsInRange(Request.UserHostAddress))
            {
                isAllowed = true;
                break;
            }
        }

        if (!isAllowed)
        {
            Response.Clear();
            Response.StatusCode = 403;
            Response.StatusDescription = "Access denied due to ACL restrictions";
            Response.End();
        }
    }
    
    private void AuthorizeUserIfNecessary()
    {
        if (Rest.Configuration.Options.ServiceProxyAuthorizationManager == null)
        {
            return;
        }

        AuthorizationHeader header;

        if (!AuthorizationHeaderParser.TryParse(Request.Headers["Authorization"], Encoding.Default, out header) ||
            !String.Equals("Basic", header.AuthenticationType, StringComparison.OrdinalIgnoreCase))
        {
            GenerateAuthenticationHeader();
            return;
        }

        Credentials credentials = configurationOptions.ServiceProxyAuthorizationManager.GetCredentials(header.UserName);

        if (credentials == null || !String.Equals(header.Password, credentials.Password, StringComparison.Ordinal))
        {
            GenerateAuthenticationHeader();
        }
    }

    private void GenerateAuthenticationHeader()
    {
        Response.Clear();
        Response.AppendHeader("WWW-Authenticate", String.Format(CultureInfo.InvariantCulture, "Basic realm=\"{0}\"", Request.ApplicationPath));
        Response.StatusCode = 401;
        Response.StatusDescription = "Unauthorized";
        Response.End();
    }

    private string GetUrlFromRoute(string routeName)
    {
        VirtualPathData pathData = RouteTable.Routes.GetVirtualPath(null, routeName, new RouteValueDictionary());

        if (pathData != null && !String.IsNullOrEmpty(pathData.VirtualPath))
        {
            return pathData.VirtualPath;
        }

        Response.Clear();
        Response.StatusCode = 404;
        Response.StatusDescription = String.Format(CultureInfo.InvariantCulture, "Invalid route '{0}' specified", routeName);
        Response.End();

        return null;
    }
</script>

<!DOCTYPE html>
<html>
<head>
    <title>Service Proxy</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link type="text/css" rel="stylesheet" href="<%= GetUrlFromRoute("ProxyCss") %>" />
    <script type="text/javascript" src="<%= GetUrlFromRoute("ProxyJQuery") %>"></script>
</head>
<body>
<p class="heading1">
    <a href="index" title="Service proxy home page">Service Proxy</a>
    <% if (!String.IsNullOrEmpty(Rest.Configuration.Options.ServiceDescription)) { %>
    <span class="heading2"><%: Rest.Configuration.Options.ServiceDescription %></span>
    <% } %>
</p>
<div id="content">
    <asp:ContentPlaceHolder runat="server" ID="bodyPlaceholder"></asp:ContentPlaceHolder>
</div>
<div id="footer">
    This web service was built with the <strong>REST Foundation v<%= Rest.FoundationAssembly.GetName().Version %></strong> framework (c) 2012-<%= DateTime.Now.Year %> by Dmitry Starosta
</div>
</body>
</html>
